name: Deploy

on:
  push:
    branches: [main]
    tags:
      - "v*"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²ç”¨äºç‰ˆæœ¬å·

      - name: ğŸ”§ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ğŸ“¥ å®‰è£…ä¾èµ–
        run: |
          npm install -g pnpm
          pnpm install

      - name: ğŸ—ï¸ æ„å»ºå¾®ä¿¡å°ç¨‹åº
        run: pnpm run build:weapp
        env:
          NODE_ENV: production

      - name: ğŸ“¦ æ‰“åŒ…æ„å»ºäº§ç‰©
        run: |
          cd dist
          tar -czf ../weapp-${{ github.sha }}.tar.gz .
          cd ..

      - name: ğŸš€ ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼ˆå¯é€‰ï¼‰
        if: github.ref == 'refs/heads/main'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          source: "weapp-${{ github.sha }}.tar.gz"
          target: "/var/www/deploys/"

      - name: ğŸ“ åˆ›å»º Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: weapp-${{ github.sha }}.tar.gz
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ’¬ å‘é€éƒ¨ç½²é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
        if: success()
        run: |
          echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
          echo "æäº¤: ${{ github.sha }}"
          echo "åˆ†æ”¯: ${{ github.ref_name }}"
